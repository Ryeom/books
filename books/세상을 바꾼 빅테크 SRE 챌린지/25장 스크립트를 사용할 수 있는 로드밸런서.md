**스크립트 가능한 로드밸런서(Scriptable Load Balancer)**는 **루아(Lua)**와 같은 스크립팅 언어를 통해 요청/응답 처리 흐름에 **고성능 맞춤 로직**을 추가하는 프록시이다. 이는 애플리케이션 계층이 아닌 **인프라 엣지**에서 샤딩 라우팅, DDoS 완화, 무중단 배포(요청 일시 중지)와 같은 복잡한 문제를 **우아하고 신뢰성 있게** 해결함으로써 SRE 팀의 **노동(Toil)을 줄이고 확장성을 근본적으로 개선**하는 핵심 툴임.

#### **1. 스크립트 가능한 로드밸런서의 가치와 필요성**

- **문제 해결의 새로운 영역:** 기존의 로드밸런서는 제한된 선언적 설정 언어로 인해 복잡한 애플리케이션 로직을 구현하기 어려웠음. 이로 인해 대규모 IT 기업(Google, Facebook)만이 자체적인 '애플리케이션 인식 로드밸런서'를 구축할 수 있었음.
- **복잡성 및 노동 제거:** 스크립트 가능한 로드밸런서는 루아와 같은 안전하고 고급 스크립팅 언어를 지원하여, C 기반 플러그인의 **메모리 결함 위험(불안정성)** 없이 **샌드박스 환경**에서 맞춤 로직을 실행함. 이는 로직 구현의 복잡성을 낮추고 SRE 팀의 운영 부담을 경감함.
- **주요 프로젝트:** **OpenResty** (Nginx + LuaJIT)와 **nginScript** (Nginx + JavaScript)가 현재 시장을 이끌고 있음.

#### **2. 주요 활용 사례: 인프라 문제의 로드밸런서 계층 분리**

스크립트 가능한 로드밸런서는 복원력, 성능, 보안과 관련된 인프라 문제를 애플리케이션에서 분리하여 엣지 계층에서 투명하게 처리함.

- **샤드 인식 라우팅 (Sharding-Aware Routing) 혁신:**
    - 기존 샤딩 라우팅 방식(DNS, 애플리케이션 쿼리, 요청 백홀링)은 복잡성을 증가시키거나 확장성을 훼손함.
    - 스크립트 가능한 LB는 요청 속성(Host, URI, IP) 또는 데이터베이스 쿼리를 기반으로 **라우팅 로직을 완전히 제어**하여 요청을 올바른 샤드로 직접 프록싱함. 애플리케이션이 샤딩에 대해 **거의 또는 전혀 인식하지 않도록** 문제를 분리함(Google의 Slicer 접근 방식과 유사함).
- **무중단 배포 및 유지 보수:**
    - **요청 일시 중지(Request Pausing)** 기능을 구현하여, 배포나 유지 보수 중 클라이언트 요청이 실패(5xx)하는 대신 로드밸런서에서 잠시 대기하게 함.
    - 서비스가 정상화되면 요청을 천천히 업스트림으로 전달하여 **SLO 위반을 최소화**하고 복원력을 높임.
- **서비스 레벨 미들웨어:**
    - 인증, WAF(Web Application Firewall) 및 Bot 완화, 캐싱 제어 등 **다수 서비스에 공통으로 필요한 로직**을 LB 계층에서 투명하게 처리함.
    - 프로덕트 개발자가 외부 서비스 호출의 **오버헤드와 복잡성**에서 벗어나 핵심 로직에 집중할 수 있게 함. (예: ID 서비스를 직접 호출하는 대신 LB가 인증 헤더를 삽입하여 전달)

#### **3. 상태 관리 및 복원력 확보**

- **엣지 상태 관리의 중요성:** 스로틀링(Throttling)이나 체크아웃 큐와 같이 **세션 상태**를 기반으로 판단해야 하는 로직은 단일 장애 지점(Single Point of Failure)을 만들거나 복잡성을 증가시키기 쉬움.
- **분산된 상태 관리:** 모든 로드밸런서가 공유 데이터베이스를 통해 상태를 동기화하는 방식(일관성 높음)은 지연 시간 및 오버헤드가 큼.
- **복원력 우선 접근:** 쇼피파이의 체크아웃 큐 사례처럼, **개별 로드밸런서에 상태를 분산 저장**하고 타임스탬프를 쿠키를 통해 클라이언트에 저장하여, 약간의 정확성을 희생하더라도 **시스템의 회복력(복원력)**을 극대화하는 솔루션을 제공함.

---

## 주요 용어 정리

- **스크립트 가능한 로드밸런서 (Scriptable Load Balancer):** 루아(Lua) 등 스크립팅 언어로 요청/응답 처리 로직을 프로그래밍할 수 있어, 엣지 계층에서 고급 애플리케이션 인식 기능을 구현하는 프록시이다.
- **샤드 (Shard):** 대규모 데이터베이스를 관리 가능한 작은 덩어리로 논리적으로 분할하여 여러 노드에 분산 저장하는 단위이다.
- **요청 백홀링 (Request Backhauling):** 애플리케이션 서버가 자신이 처리할 수 없는 요청을 올바른 샤드 또는 프로세스로 다시 프록시(Proxy)하여 전달하는 행위이다.
- **서비스 레벨 미들웨어 (Service-Level Middleware):** 로드밸런서 계층에서 요청이 업스트림 애플리케이션에 도달하기 전에 투명하게 작동하며, 인증이나 보안 같은 공통 로직을 처리하는 기능이다.
- **요청 일시 중지 (Request Pausing):** 배포 또는 유지 보수 기간 동안 로드밸런서가 클라이언트의 요청을 잠시 대기(Buffering)시켰다가, 서비스가 준비되면 천천히 전달하여 에러 발생을 막는 기법이다.
- **WAF (Web Application Firewall):** 웹 애플리케이션을 OWASP 취약성, DDoS 공격, 봇 악용 등으로부터 보호하기 위해 HTTP 통신을 모니터링하고 필터링하는 방화벽이다.
- **PID 컨트롤러 (Proportional-Integral-Derivative Controller):** 목표값과 현재 출력값의 오차를 기반으로 제어값을 계산하여 시스템을 제어하는 피드백 제어 기법이다. 쇼피파이의 체크아웃 큐에서 스로틀링 제한값 조정에 사용된 기법이다.