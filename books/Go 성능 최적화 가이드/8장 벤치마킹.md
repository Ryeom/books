# CHAPTER 8: 벤치마킹

## 요약
8장은 Go에서 **마이크로벤치마킹**과 **매크로벤치마킹**을 다루며, 코드를 최적화하고 성능을 개선하는 방법을 설명함.

---

## 8.1 마이크로벤치마크
### 정의
- 코드 일부(기능 단위) 효율성을 측정.
- 주로 알고리즘 최적화에 사용.

### 특징
- 작고 단순해야 함.
- 실행 시간과 메모리 사용량을 측정.
- 반복 실행으로 신뢰도 향상.

### 구현 예시
- `go test`를 사용해 벤치마크 작성.
- 파일 이름: `_test.go`.
- 함수 이름: `Benchmark<name>`.

```go
func BenchmarkSum(b *testing.B) {
    for i := 0; i < b.N; i++ {
        _ = Sum("testdata/test.2M.txt")
    }
}
```

### 도구

- **benchstat**: 결과 비교 및 통계 분석.

---

## 8.2 마이크로벤치마킹 팁과 트릭

### 주요 원칙

1. 분산(Variance) 관리:
    - 테스트 환경에서의 외부 노이즈 최소화.
    - 충분히 오래 실행해 안정된 결과 확인.
2. 워크플로:
    - 초기 기준점(baseline) 설정.
    - 최적화 후 결과 비교.
3. 에러 체크:
    - 벤치마크 도중 발생할 수 있는 에러 확인.
4. 공유 및 재사용:
    - 벤치마크 코드를 저장소에 커밋해 팀원과 공유.
    - 테스트 데이터는 동적으로 생성하거나 캐싱.

---

## 8.3 매크로벤치마크

### 정의

- 시스템 수준의 성능 평가.
- 여러 컴포넌트가 결합된 애플리케이션이나 서비스 전체를 테스트.

### 특징

- **마이크로벤치마크**와 달리 외부 의존성과 관찰 가능성 포함.
- 프로덕션 환경과 비슷한 설정에서 실행.

### 주요 컴포넌트

1. **테스트 대상 시스템**: 분리된 프로세스에서 실행.
2. **의존성 관리**: 오브젝트 스토리지 등 외부 의존성 설정.
3. **부하 테스터**: k6와 같은 도구 사용.
4. **관찰 가능성**: Prometheus를 통해 모니터링.
5. **CI/CD 통합**: 지속적 통합 및 배포 환경에서 테스트.

#### 구현 예시
```go
func TestLabeler_LabelObject(t *testing.T) {
    e, err := e2e.NewDockerEnvironment("labeler")
    testutil.Ok(t, err)
    t.Cleanup(e.Close)

    // 관찰 가능성 추가
    mon, err := e2emonitoring.Start(e)
    testutil.Ok(t, err)

    // Minio 설정
    minio := e2edb.NewMinio(e, "object-storage", "test")
    testutil.Ok(t, e2e.StartAndWaitReady(minio))

    // Labeler 실행
    labeler := e2e.NewInstrumentedRunnable(e, "labeler").
        WithPorts(map[string]int{"http": 8080}, "http").
        Init(e2e.StartOptions{
            Image: "labeler:test",
            Command: e2e.NewCommand(
                "/labeler",
                "-listen-address=:8080",
            ),
        })
    testutil.Ok(t, e2e.StartAndWaitReady(labeler))
}

```

## 8.4 일반적인 매크로벤치마킹 워크플로

1. 벤치마크 환경 구성:
    - 도커 컨테이너나 로컬 서버 활용.
2. 테스트 데이터 준비:
    - 입력 데이터를 동적으로 생성.
3. 부하 테스트 실행:
    - k6와 같은 도구로 HTTP 호출 시뮬레이션.
4. 결과 분석:
    - 평균, P90, P95 등의 주요 지표 확인.
    - Prometheus를 사용해 메트릭 수집 및 시각화.

---

## 8.5 마치며

- **마이크로벤치마크**는 코드의 작은 부분을 최적화하는 데 유용.
- **매크로벤치마크**는 전체 시스템의 성능 병목을 식별하고 개선.
- 효과적인 벤치마크는 코드 품질과 성능 개선의 중요한 기반.

벤치마크는 코드를 이해하고 개선하기 위한 강력한 도구임. 
마이크로와 매크로 수준의 균형 잡힌 테스트로 효율성을 극대화 가능.
