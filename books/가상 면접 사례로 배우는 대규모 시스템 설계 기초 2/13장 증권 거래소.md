
이 설계의 핵심은 하루 10억 건의 주문과 최대 215,000 QPS를 처리하며 밀리초(ms) 수준의 초저지연 시간과 99.99% 가용성을 확보하는 온라인 증권 거래 시스템 구축에 중점을 둔다. 금융 거래의 특성상 결정론(Determinism)과 데이터 무결성이 가장 중요한 기술적 도전이다.

### 1. 근본적인 도전: 지연 시간 제거와 데이터 무결성

- 지연 시간 최적화: 거래 흐름(Trading Flow)은 주문 접수부터 체결까지의 지연 시간이 p99 밀리초 수준에 묶여야 한다. 이 목표 달성을 위해 네트워크와 디스크 접근에 소요되는 시간을 제거하는 것이 핵심이었다.
- 결정론적 체결: 주문이 들어온 순서대로 정확하게 체결되어야 한다(FIFO). 이는 복구(Recovery) 시 이벤트를 재생해도 항상 같은 결과가 나오도록 시스템 전체의 결정론(Determinism)을 보장하는 기반이다.

### 2. 핵심 해결책: 단일 서버와 이벤트 소싱

지연 시간과 무결성 문제를 해결하기 위해 다음과 같은 첨단 아키텍처를 채택했다.

|설계 요소|기술 및 원리|비즈니스 가치 및 효과|
|---|---|---|
|초저지연 경로|모든 핵심 컴포넌트를 단일 서버에 배치하고, mmap을 이용한 공유 메모리로 통신.|네트워크 왕복(수 ms) 및 디스크 접근 지연을 제거하고, 통신 시간을 마이크로초 미만으로 단축함.|
|결정론 및 순서|시퀀서(Sequencer)가 주문 및 집행 기록에 순서 ID를 부여하고 정렬함.|시스템에 들어오는 모든 이벤트를 결정론적으로 정렬하여 체결 엔진의 신뢰성 및 복구 가능성을 확보함.|
|무결성 및 복구|래프트(Raft) 합의 알고리즘을 통한 이벤트 저장소(Event Store) 복제.|체결 엔진의 결정론적 특성 덕분에 주 서버 장애 시 이벤트 로그만 재생하여 신속하고 정확하게 상태를 복구(RTO/RPO 목표 달성)함.|
|성능 튜닝|애플리케이션 루프를 단일 스레드로 특정 CPU 코어에 고정(Pinning)함.|락(Lock) 경합과 문맥 전환(Context Switch) 오버헤드를 제거하여 p99 지연 시간을 안정적으로 낮춤.|

### 3. 부가 시스템 및 문화적 요소

- 시장 데이터 분배: 체결 결과를 시장 데이터 게시 서비스(MDP)가 호가 창과 봉 차트로 가공하고, 멀티캐스트(Multicast) 프로토콜을 사용해 공정하고 신속하게 데이터를 브로커에게 전송함.
- 보안 및 규정: KYC(Know Your Client)와 같은 법규 준수 외에도, 기관 고객에게 초저지연 거래를 제공하는 코로케이션(Colocation) 서비스는 공정성 확보와 수익성 사이의 중요한 타협점임.
- 안티패턴 경계: 지연 시간을 늘리는 변경 제어 위원회(CCB)와 같은 프로세스를 지양하고, 에러 예산을 활용하여 신뢰성과 속도의 균형을 유지함.

---

## 주요 용어 정리

- 지정가 주문 (Limit Order): 가격이 고정된 매수 또는 매도 주문이다. 즉시 체결되지 않을 수 있고, 호가 창(Order Book)에 등록되어 대기한다.
- 호가 창 (Order Book): 특정 증권에 대한 매수 주문과 매도 주문의 목록을 가격 수준별로 실시간으로 정리한 핵심 자료 구조이다. 체결 엔진이 주문을 연결하는 데 사용한다.
- 체결 엔진 (Matching Engine): 주문을 연결(Match)하여 거래를 성사시키고, 집행 기록(Execution)을 생성하는 거래소의 핵심 컴포넌트이다.
- 시퀀서 (Sequencer): 거래소에 들어오는 모든 주문과 나가는 집행 기록에 순서 ID를 부여하여 정렬하는 컴포넌트이다. 시스템의 결정론을 보장하는 데 필수적이다.
- 결정론 (Determinism): 시스템에 동일한 입력이 주어지면 언제나 동일한 결과와 동일한 이벤트 순서를 산출하도록 보장하는 시스템 속성이다. 장애 복구 시 상태 재생(Replay)의 정확성을 보장하는 기반이다.
- mmap (Memory Map): 파일이나 장치를 프로세스의 메모리 공간에 직접 매핑하는 UNIX 시스템 호출이다. 거래소 설계에서 공유 메모리 기반 메시지 버스를 구현하여 네트워크 및 디스크 I/O를 제거하는 데 사용된다.
- 래프트 (Raft) 알고리즘: 분산 시스템에서 리더를 선출하고 데이터 복제본 간의 합의(Consensus)를 이끌어내어 데이터 무결성과 시스템 안정성을 보장하는 알고리즘이다.
- 코로케이션 (Colocation): 기관 고객(브로커)의 서버를 거래소 서버와 같은 데이터 센터에 물리적으로 배치하는 서비스이다. 네트워크 지연 시간을 극도로 낮춰 초고속 거래를 가능하게 한다.