이번 장에서는 **근접성 서비스(proximity service)**를 설계한다. 근접성 서비스는 음식점, 호텔, 극장, 박물관 등 현재 위치에서 가까운 시설을 찾는 데 이용되며, 옐프(Yelp) 앱의 경우에는 주변에 있는 좋은 식당 검색, 구글 맵의 경우에는 가까운 k개 주유소 검색 등의 기능 구현에 이용된다.

### **1단계: 문제 이해 및 설계 범위 확정**

옐프가 제공하는 모든 기능을 인터뷰 시간 내에 설계할 수 없다. 그러니 질문을 던져 설계 범위를 좁혀야 한다. 다음은 면접관과 지원자의 대화 사례다.

**지원자/면접관 대화 내용**

- **검색 범위:** 일단은 주어진 반경(radius) 내의 사업장만 대상으로 한다.
- **최대 허용 반경:** 20km(12.5mile)로 가정해도 괜찮다.
- **UI 검색 반경 선택지:** 0.5km(0.31mile), 1km(0.62mile), 2km(1.24mile), 5km(3.1mile), 그리고 20km(12.42mile)이다.
- **사업장 정보 갱신:** 사업장 소유주가 사업장 정보를 시스템에 추가, 삭제, 갱신할 수 있어야 한다. 새로 추가하거나 갱신한 정보는 **다음날까지 반영**되어야 한다고 계약서에 명시되어 있다고 가정한다.
- **실시간 화면 갱신:** 사용자의 이동 속도가 그리 빠르지 않아서 상시적으로 페이지를 갱신할 필요는 없다고 가정한다.

**기능 요구사항**

이 대화에 근거하여, 다음 세 가지 핵심 기능에 집중할 것이다.

- 사용자의 위치(경도와 위도 쌍)와 검색 반경 정보에 매치되는 사업장 목록을 반환한다.
- 사업장 소유주가 사업장 정보를 추가, 삭제, 갱신할 수 있도록 하되, 그 정보가 검색 결과에 실시간으로 반영될 필요는 없다고 가정한다.
- 고객은 사업장의 상세 정보를 살필 수 있어야 한다.

**비기능 요구사항**

사업 요구사항으로부터 다음과 같은 비기능 요구사항(non-functional requirements)을 도출할 수 있다. 이 각각을 면접관과 확인해야 한다.

- **낮은 응답 지연(Latency):** 사용자는 주변 사업장을 신속히 검색할 수 있어야 한다.
- **데이터 보호(Data Privacy):** 사용자 위치는 민감한 정보다. 위치 기반 서비스(Location-Based Service, LBS)를 설계할 때는 언제나 사용자의 정보를 보호할 방법을 고려해야 한다. 데이터 사생활 보호 법안을 준수하도록 해야 한다.
- **고가용성(High Availability) 및 규모 확장성(Scalability) 요구사항:** 인구 밀집 지역에서 이용자가 집중되는 시간에 트래픽이 급증해도 감당할 수 있도록 시스템을 설계해야 한다.

**개략적 규모 추정**

시스템의 규모가 대략 어느 정도이며 어떤 수준의 도전적 과제를 해결해야 하는지 결정하기 위해, 개략적인 추정(back-of-the-envelope calculation)을 해보도록 하자. 일간 능동 사용자(Daily Active User, DAU)는 1억 명(100 million)이며 등록된 사업장 수는 2억(200 million)이라고 가정한다.

- **QPS (Query per Second) 계산**
    - 1일은 10⁵초라고 가정한다.
    - 한 사용자는 하루에 5회 검색을 시도한다고 가정한다.
    - 따라서 QPS = (1억 x 5) / 10⁵ ≈ **5,000**이다.

### **2단계: 개략적 설계안 제시 및 동의 구하기**

이번 절에서는 **API 설계, 개략적 설계안, 주변 사업장 검색 알고리즘, 데이터 모델**을 논의할 것이다.

**API 설계**

RESTful API 관례를 따르는 간단한 API를 만들어 보도록 하겠다.

- **검색 API:**
    - **요청:** `GET /v1/search/nearby`
    - **인자:** `latitude` (위도), `longitude` (경도), `radius` (선택적, 기본값 5000m)
    - **반환:** 검색 조건에 맞는 사업장 객체 목록 (`total`, `businesses: [business object]`)
- **사업장 관련 API:**
    - `GET /v1/businesses/:id`: 특정 사업장의 상세 정보 반환
    - `POST /v1/businesses`: 새로운 사업장 추가
    - `PUT /v1/businesses/:id`: 사업장 상세 정보 갱신
    - `DELETE /v1/businesses/:id`: 특정 사업장 정보 삭제

**데이터 모델**

읽기/쓰기 비율

읽기 연산(주변 사업장 검색, 정보 확인)은 굉장히 자주 수행되는 반면, 쓰기 연산(추가, 삭제, 편집) 실행 빈도는 낮다. 읽기 연산이 압도적인 시스템에는 MySQL 같은 관계형 데이터베이스가 바람직할 수 있다.

데이터 스키마

이 시스템의 핵심이 되는 테이블은 business 테이블과 지리적 위치 색인 테이블이다.

- **`business` 테이블:** 사업장 상세 정보를 담으며, 기본 키(primary key)는 `business_id`이다.
- **지리적 위치 색인 테이블:** 위치 정보 관련 연산의 효율성을 높이는 데 쓰이며, **지오해시(geohash)**에 대한 지식이 필요하다.

**개략적 설계**

그림 1.2는 개략적 설계안의 다이어그램이다. 이 시스템은 **위치 기반 서비스(LBS)**와 **사업장 관련 서비스** 두 부분으로 구성된다.

**그림 1.2 개략적 설계안**

- **로드밸런서:** 유입 트래픽을 자동으로 여러 서비스에 분산시키는 컴포넌트다. URL 경로를 분석하여 어느 서비스에 트래픽을 전달할지 결정한다.
- **위치 기반 서비스(LBS):** 시스템의 핵심 부분으로, 주변 사업장을 검색한다. 읽기 요청만 빈번하며, QPS가 높고, 무상태(Stateless) 서비스이므로 수평적 규모 확장이 쉽다.
- **사업장 서비스:** 쓰기 요청(추가, 삭제, 갱신)과 읽기 요청(조회)을 처리한다.
- **데이터베이스 클러스터:** 주(Primary)-부(Secondary, 사본) 데이터베이스 형태로 구성한다. 주 데이터베이스는 쓰기 요청을 처리하며, 사본 데이터베이스는 읽기 요청을 처리한다. 사업장 정보는 실시간 갱신될 필요가 없으므로 주 데이터베이스와 사본 데이터베이스 간의 **복제 시간 지연(delay)**은 용인된다.

사업장 서비스와 LBS의 규모 확장성

사업장 서비스와 LBS는 둘 다 무상태 서비스이므로 특정 시간대의 집중 트래픽에 자동으로 서버를 추가하고, 유휴 시간에는 서버를 삭제하도록 구성할 수 있다. 시스템을 클라우드에 둔다면 여러 지역, 여러 가용성 구역에 서버를 두어 시스템 가용성을 높일 수 있다.

**주변 사업장 검색 알고리즘**

주변 사업장 검색 방법을 살펴볼 것이다. 면접 시에는 지리적 위치 색인(geospatial index)이 어떻게 동작하는지 설명함으로써 문제 풀이 능력과 기술적 지식을 갖추었음을 보이는 것이 좋다.

방안 1: 2차원 검색

주어진 반경으로 그린 원 안에 놓인 사업장을 검색하는 방법이다. 가장 직관적이지만 지나치게 단순하다. 위도와 경도 칼럼에 색인을 만들더라도 데이터가 2차원적이므로 두 집합의 교집합 연산이 엄청난 양 때문에 효율적일 수 없다. 이 방안의 문제는 데이터베이스 색인으로는 오직 한 차원의 검색 속도만 개선할 수 있다는 것이다.

지리적 정보 색인 방안 유형

2차원 데이터를 한 차원에 대응시킬 방법을 찾아야 한다. 지리적 정보에 색인을 만드는 방법은 크게 해시 기반과 트리 기반 두 종류이다.

- **해시 기반 방안:** 균등 격자(even grid), 지오해시(geohash), 카르테시안 계층(cartesian tiers) 등
- **트리 기반 방안:** 쿼드트리(quadtree), 구글 S2, R 트리(R-tree) 등

그 가운데 **지오해시, 쿼드트리, 구글 S2**가 실제로 가장 널리 사용된다.

방안 2: 균등 격자

지도를 작은 격자 또는 구획으로 나누는 단순한 접근법이다. 동작은 하지만, 사업장 분포가 균등하지 않으므로 데이터 분포가 전혀 균등하지 않다는 중요한 문제가 있다.

방안 3: 지오해시(Geohash)

지오해시는 2차원의 위도 경도 데이터를 1차원의 문자열로 변환한다. 비트를 하나씩 늘려가면서 재귀적으로 세계를 더 작은 격자로 분할해 나간다. 통상적으로 base32 표현법을 사용하며, 4에서 6 사이의 길이를 갖는다. 지오해시 길이는 격자 크기를 결정하며, 사용자가 지정한 반경을 덮는 최소 크기 격자를 만드는 길이를 구해야 한다.

- **경계 조건 이슈 1:** 아주 가까운 두 위치가 적도나 자오선의 다른 쪽에 놓이는 경우, **어떤 공통 접두어도 갖지 않을 수 있다**. 단순한 접두어 기반 SQL 질의문으로는 주변 모든 사업장을 가져올 수 없다.
- **경계 조건 이슈 2:** 두 지점이 공통 접두어 길이는 길지만 서로 다른 격자에 놓이는 경우다.
- **해결책:** 가장 흔히 사용되는 해결책은 현재 격자를 비롯한 **인접한 모든 격자**의 모든 사업장 정보를 가져오는 것이다. 특정 지오해시의 주변 지오해시를 찾는 것은 **상수 시간(constant time)**에 가능한 연산이다.
- **검색 범위 확대:** 현재 격자와 주변 격자를 다 살펴보아도 표시할 사업장이 충분하지 않을 경우, 지오해시 값의 마지막 비트를 삭제하여 얻은 새 지오해시 값을 사용해 **검색 반경을 확장**하는 방안을 고려한다.

방안 4: 쿼드트리(Quadtree)

쿼드트리는 격자의 내용이 특정 기준(예: 격자에 담긴 사업장 수가 100 이하)을 만족할 때까지 2차원 공간을 재귀적으로 사분면 분할하는 메모리 기반(in-memory) 자료 구조다. 이 자료 구조는 각각의 LBS 서버에 존재하며, 서버 시작 시점에 구축된다.

- **메모리 요구량:** 2억 개 사업장(200m) 기준, 총 메모리 요구량은 약 **1.71GB**로, 서버 한 대에 충분히 올릴 수 있다.
- **트리 구축 시간:** 쿼드트리 구축의 시간 복잡도는 O(N log N)이다.
- **운영 시 고려사항:**
    - 서버 시작 시 트리 구축 시간이 길어질 수 있다.
    - 사업장이 추가/삭제되었을 때 쿼드트리를 점진적으로 갱신해야 한다. 실시간 갱신은 락(lock) 메커니즘이 필요해 설계가 복잡해진다.

방안 5: 구글 S2

구글 S2 기하 라이브러리는 지구(sphere)를 **힐베르트 곡선(Hilbert curve)**이라는 공간 채움 곡선을 사용하여 1차원 색인화하는 방안이다. S2는 면접 중 설명하기 까다롭지만, 지오펜스(geofence) 구현 및 **영역 지정 알고리즘(Region Cover Algorithm)**을 통해 유연한 셀 크기를 지정할 수 있는 장점이 있다.

추천

면접 시에는 지오해시나 쿼드트리 가운데 하나를 선택하길 추천한다.

**지오해시 vs 쿼드트리**

- **지오해시:** 구현과 사용이 쉽다. **정밀도를 고정**하면 격자 크기도 고정되므로, 인구 밀도에 따라 동적으로 격자 크기를 조정할 수 없다. 색인 갱신이 쉽다.
- **쿼드트리:** 구현이 살짝 더 까다롭다. **인구 밀도에 따라 격자 크기를 동적으로 조정**할 수 있는 장점이 있다. **k번째로 가까운 사업장** 목록을 구할 수 있어 검색 기능 확장성이 좋다. 색인 갱신 시간 복잡도는 O(log N)이다.

### **3단계: 상세 설계**

**데이터베이스의 규모 확장성**

- **사업장 테이블:** 데이터가 방대하므로 **사업장 ID**를 기준으로 **샤딩(sharding)**을 적용하기 좋다. 이는 부하를 고르게 분산하고 관리가 쉬운 방법이다.
- **지리 정보 색인 테이블:** 전체 데이터양이 많지 않으므로 샤딩보다 **읽기 부하를 분산**할 **사본 데이터베이스 서버(복제)**를 두는 전략이 더 좋다. 테이블은 `geohash`와 `business_id`를 각각 별도 열로 저장하고, 이 둘을 합친 `(geohash, business_id)`를 복합 키(compound key)로 사용하면 갱신 연산 시 락을 사용할 필요가 없어 구현이 쉽다.

**캐시**

읽기 연산의 빈도가 높고 데이터베이스 서버 한 대의 CPU와 네트워크 대역폭으로 요청을 감당하기 어려운 경우에 캐시 계층 도입이 필요하다.

- **캐시 키:** 사용자 위치 정보는 매 측정마다 달라지므로 부적절하다. **지오해시**나 **쿼드트리**를 사용해 **같은 격자 내 모든 사업장이 같은 해시 값**을 갖도록 만들어 캐시 키로 사용한다.
- **캐시 데이터 유형:** **지오해시**(`key`)에 대응되는 **해당 격자 내의 사업장 ID 목록**(`value`)과, **사업장 ID**(`key`)에 대응되는 **사업장 정보 객체**(`value`)를 레디스(Redis) 같은 키-값 저장소에 보관한다.
- **규모 확장:** **고가용성** 및 **트래픽 지연 방지**를 위해 **레디스 클러스터**를 전 세계 지역별로 두고 데이터를 중복 저장해야 한다. (최종 설계도에서는 `지오해시`와 `사업장 정보` 캐시로 지칭한다.)
- **갱신:** 사업장 정보 갱신은 빈도가 낮아 캐시된 항목의 **무효화(invalidate)** 작업을 밤사이 일괄 갱신하는 방식으로 처리한다.

**지역 및 가용성 구역**

위치 기반 서비스(LBS)를 여러 지역과 가용성 구역에 설치하여 다음 효과를 얻는다.

- **지연 시간 감소:** 사용자와 시스템 사이의 물리적 거리를 최소화한다.
- **가용성 증대:** 여러 가용성 구역에 서버를 두어 가용성을 높인다.
- **법규 준수:** 특정 국가의 사생활 보호법(데이터 현지 저장 의무)을 준수할 수 있도록 해당 국가를 별도 지역으로 지정하여 운영한다.

추가 질문: 시간대, 혹은 사업장 유형별 검색

근처 사업장 ID를 먼저 전부 확보한 다음, 해당 사업장 정보를 추출하여 영업시간이나 사업장 유형에 따라 필터링하여 반환한다. (관련 정보는 사업장 정보 테이블에 보관되어 있어야 한다.)

최종 설계도

그림 1.21은 이 모든 구성 요소를 통합한 최종 설계도다.

**그림 1.21 최종 설계도**

**주변 사업장 검색 과정 (500m 반경 검색 예시)**

1. 클라이언트 앱은 위치 및 반경 정보를 로드밸런서로 전송한다.
2. LBS가 검색 요건에 맞는 지오해시 길이(500m → 길이 6)를 계산하고, **인접한 지오해시** 목록을 확보한다.
3. LBS는 `지오해시` 레디스 서버를 호출하여 해당 지오해시별 **모든 사업장 ID**를 추출한다.
4. 반환된 사업장 ID들을 가지고 `사업장 정보` 레디스 서버를 조회하여 각 사업장의 상세 정보를 취득한다.
5. 상세 정보에 의거하여 사업장과 사용자 간 거리를 계산하고, 우선순위를 매긴 다음 클라이언트 앱에 반환한다.

사업장 정보 조회, 갱신, 추가 그리고 삭제

모든 사업장 정보 관련 API는 사업장 정보 서비스를 통해 처리된다.

- 조회 요청은 우선 **`사업장 정보` 레디스 서버**를 조회하고, 캐시에 없을 경우 데이터베이스 클러스터에서 읽어 캐시에 저장한 다음 반환한다.
- 새로 추가하거나 갱신한 정보는 다음날 반영된다는 합의에 따라, 캐시된 정보 갱신은 **밤사이 일괄 작업**을 돌려서 처리한다.

### **4단계: 마무리**

이번 장에서 주변 검색 기능의 핵심인 근접성 서비스를 설계하였음. **지오해시**를 지리 정보 색인 기법으로 채택하였고, **캐시(레디스 클러스터)**와 **데이터베이스 복제/샤딩**을 활용해 지연 시간을 감소시키고 규모 확장성을 확보하였다. 또한 여러 지역과 가용성 구역에 시스템을 배치하여 가용성을 높이고 **법규 준수**를 고려하였음을 확인한다.


---

## **주요 용어 정리**

- **근접성 서비스 (Proximity Service):** 사용자의 현재 위치를 기반으로 주변 시설이나 사업장을 검색하는 기능을 제공하는 서비스이다.
- **DAU (Daily Active User):** 일간 능동 사용자 수로, 시스템의 규모를 추정하는 핵심 지표이다.
- **LBS (Location-Based Service):** 위치 기반 서비스. 사용자의 지리적 위치 정보를 활용하여 맞춤형 서비스를 제공하는 시스템이다.
- **지리적 위치 색인 (Geospatial Index):** 위도와 경도 같은 2차원 공간 데이터를 효율적으로 검색하기 위해 1차원 또는 트리 구조로 변환하여 사용하는 인덱싱 기법이다.
- **지오해시 (Geohash):** 2차원 좌표를 **1차원 문자열**로 변환하여 인덱싱하는 해시 기반 기법이다. 구현이 간단하지만, 격자 경계에서 인접한 위치가 다른 해시 값을 가질 수 있는 경계 이슈가 있다.
- **쿼드트리 (Quadtree):** 2차원 공간을 재귀적으로 사분면 분할하는 **메모리 기반의 트리 자료 구조**이다. 인구 밀도에 따라 동적으로 격자 크기를 조정하는 장점이 있다.
- **구글 S2 (Google S2):** 구글에서 개발한 지리적 색인 라이브러리. 지구 표면을 힐베르트 곡선으로 1차원 변환하여 지오펜스(Geofence) 구현 등에 사용된다.
- **샤딩 (Sharding):** 대규모 데이터베이스를 여러 개의 작은 조각(Shard)으로 분할하여 분산 저장하는 기술이다. 규모 확장성을 확보하는 데 필수적이다.
- **복합 키 (Compound Key):** 두 개 이상의 칼럼을 조합하여 만든 기본 키로, 데이터의 고유성을 보장하고 검색 효율을 높이는 데 사용된다.
- **복제 지연 (Replication Delay):** 주 데이터베이스에 기록된 데이터가 사본 데이터베이스에 복사되는 데 걸리는 시간 차이이다. 사업장 정보처럼 실시간 반영이 중요하지 않은 데이터에는 용인될 수 있는 지연이다.