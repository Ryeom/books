
본 설계안은 디지털 광고 시장의 급성장에 따라 중요성이 커진 **광고 클릭 이벤트 집계 시스템**을 다룬다. 핵심 목표는 매일 10억 건 이상의 클릭 이벤트가 발생하는 대규모 트래픽 환경에서 **정확성**과 **신뢰성**을 보장하며, 광고주에게 필요한 **실시간 분석 및 과금** 데이터를 **수 분 이내**에 제공하는 것이다.

설계는 **카파(Kappa) 아키텍처**를 기반으로 하며, **맵리듀스(MapReduce) 패러다임**을 적용한 스트림 처리 시스템을 핵심으로 사용함. 비동기식 처리를 위해 **메시지 큐(Kafka)** 를 활용하여 생산자-소비자 간 결합도를 낮추고, 데이터 무결성 및 정확히 한 번(Exactly Once) 처리를 위해 복잡한 트랜잭션 및 오프셋 관리 메커니즘을 적용함.

### 핵심 기능.
1. **클릭 수 집계:** 지난 M분간 특정 광고의 클릭 수를 집계함.
2. **인기 광고 식별:** 매분 가장 많이 클릭된 상위 N개 광고 목록을 반환함.
3. **필터링 지원:** IP, 국가, 사용자 ID 등 다양한 속성을 기준으로 집계 결과를 필터링할 수 있음.


## 단계별 설계 분석
### 1. 문제 정의 및 요구사항 (Business Context)

광고 클릭 데이터는 광고 효과 측정(CTR, CVR)과 **광고주 과금**의 결정적 기준이 되는바, **데이터 정확성이 최우선**임.

|**구분**|**내용**|**비즈니스 중요성**|
|  ---    | -   |  ---   |
|**데이터 규모**|일일 10억 건의 클릭 이벤트, 최대 50,000 QPS (매년 30% 성장)|대규모 처리를 위한 **수평적 확장성** 요구됨.|
|**기능**|지난 M분 클릭 수, 상위 N개 광고 목록, 다차원 필터링|광고 캠페인 관리 및 실시간 의사 결정 지원함.|
|**비기능 (SLA)**|**정확성** (과금), **견고성** (장애 감내), **지연 시간** (최대 수 분 이내 처리)|과금 오류 방지 및 실시간 보고를 위한 **신뢰성** 확보됨.|
|**엣지 케이스**|지연 이벤트, 중복 이벤트, 시스템 장애 복구|데이터 무결성 및 유실 방지를 위한 **정확히 한 번 처리**가 요구됨.|
### 2. 개략적 아키텍처 및 데이터 모델

#### 2.1. 데이터 모델 및 저장 전략

데이터는 **원시 데이터 (Raw Data)** 와 **집계 결과 데이터 (Aggregated Data)** 로 분리하여 저장함.

- **원시 데이터:** 백업 및 **데이터 재계산** 용도로 사용함. 쓰기 중심 시스템이므로 카산드라(Cassandra)와 같은 **쓰기 및 시간 범위 질의에 최적화된 NoSQL DB** 사용이 권장됨.
- **집계 결과 데이터:** 활성 데이터로, 빠른 질의 성능을 위해 튜닝됨. 시계열 데이터 성격으로 카산드라 활용이 가능함.
- **필터링 구조:** 다차원 필터링을 지원하기 위해 **스타 스키마(Star Schema)** 기법을 사용하여 결과를 미리 계산해 저장함. 이는 필터링 기준에 따라 빠르게 접근 가능하게 함.

#### 2.2. 비동기 처리 및 파이프라인 구조

시스템은 생산자(로그 모니터)와 소비자(데이터 집계 서비스)를 분리하는 **비동기 처리 방식**을 채택함.

- **메시지 큐 (Kafka):** 생산자와 소비자의 결합도를 낮추고, 독립적인 규모 확장을 가능하게 하는 핵심 요소임.
    - **첫 번째 큐:** 원시 클릭 이벤트를 수집함.
    - **두 번째 큐:** 집계 서비스의 처리 결과를 담아 데이터베이스 기록 프로세스로 전달함.
- **집계 서비스:** 맵리듀스 패러다임을 DAG 모델로 구현하여 클릭 이벤트를 병렬 분산 처리하는 구조임.

### 3. 상세 설계 및 기술적 난제 해결

#### 3.1. 아키텍처 방식 및 재처리

- **카파 아키텍처:** 실시간 집계와 이력 데이터 재처리(버그 수정, 데이터 복구 시) 경로를 **단일 스트림 처리 엔진**으로 통합하여 코드 관리의 복잡성 감소를 도모함.
- **재계산 서비스:** 원시 데이터 저장소에서 데이터를 읽어와 재계산 전용 집계 서비스를 거쳐 집계 결과 데이터베이스를 갱신하는 흐름임.

#### 3.2. 정확한 시간 처리 및 윈도우

- **타임스탬프:** 집계 정확도를 위해 시스템 처리 시각보다 실제 클릭이 발생한 **이벤트 시각(Event Time)** 을 기준으로 사용함.
- **지연 이벤트 처리:** 이벤트 시각을 사용할 경우, 네트워크 지연으로 늦게 도착하는 이벤트를 포착하기 위해 **워터마크(Watermark)** 기법을 사용함. 워터마크는 집계 윈도를 시간적으로 확장하여 누락되는 이벤트를 줄이는 역할임.
- **집계 윈도:**
    - **텀블링 윈도 (Tumbling Window):** 고정된 시간 구간(예: 1분)으로 나누어 매분 클릭 수를 집계함.
    - **슬라이딩 윈도 (Sliding Window):** 겹치는 시간 구간(예: 3분 윈도를 1분마다 이동)으로 인기 광고 목록을 집계함.

#### 3.3. 전달 보장 (Exactly Once)

과금 데이터의 무결성을 위해 **정확히 한 번(Exactly Once)** 처리를 목표로 함.

- **중복 제거 난제:** 서버 장애 시 오프셋(처리 위치) 저장 실패로 인해 중복 데이터가 발생하는 문제 발생함.
- **해결책:** 집계 결과 전송, 오프셋 저장 등의 작업을 **분산 트랜잭션**으로 묶어 원자성을 보장함. 이는 장애 발생 시 작업 전체를 롤백하고 복구 후 재처리하게 하여 데이터 중복 및 손실을 방지하는 방법임.

#### 3.4. 규모 확장 및 핫스팟 대응

- **수평적 확장:** 메시지 큐, 집계 서버, 데이터베이스(카산드라) 모두 독립적으로 수평적 확장이 가능함.
    - 메시지 큐에서 **ad_id를 해시키**로 사용하여 같은 광고의 이벤트를 같은 파티션에 저장하고 집계 노드의 처리를 일관되게 유지함.
- **핫스팟 문제:** 대형 광고주의 클릭 집중으로 특정 집계 노드에 과부하가 걸리는 문제 발생함.
    - **대응:** 핫스팟이 발생한 노드가 **추가 자원을 요청**하여 이벤트를 다른 집계 노드(자식 노드)로 분할 처리하고, 그 결과를 취합하는 방식으로 부하 분산을 수행함.

---
## 주요 용어 정리

- **RTB (Real-Time Bidding, 실시간 경매):** 온라인 광고 지면(inventory)을 거래하는 핵심 프로세스임.
- **CTR (Click-Through Rate, 클릭률):** 광고가 노출된 횟수 대비 클릭된 횟수의 비율로, 광고 효율을 측정하는 핵심 지표임.
- **카파 아키텍처 (Kappa Architecture):** 실시간 데이터 처리와 이력 데이터 재처리를 단일 스트림 처리 엔진으로 통합하는 빅데이터 처리 아키텍처임.
- **맵리듀스 (MapReduce):** 빅데이터를 분산 환경에서 처리하기 위한 프로그래밍 모델임.
- **스타 스키마 (Star Schema):** 데이터 웨어하우스에서 사용되는 모델로, 중앙의 사실 테이블이 여러 차원 테이블에 연결된 구조임.
- **워터마크 (Watermark):** 지연된 이벤트가 도착할 때까지 기다리는 시간을 설정하여, 집계 윈도의 정확도를 높이는 스트림 처리 기술임.
- **정확히 한 번 (Exactly Once):** 데이터가 유실되거나 중복되지 않고, 정확하게 한 번만 처리됨을 보장하는 데이터 처리의 신뢰성 원칙임.
- **분산 트랜잭션 (Distributed Transaction):** 여러 노드나 시스템에 걸쳐 실행되는 일련의 작업을 하나의 원자적(Atomic) 단위로 처리하여, 전체 작업의 성공 또는 실패를 보장하는 메커니즘임.