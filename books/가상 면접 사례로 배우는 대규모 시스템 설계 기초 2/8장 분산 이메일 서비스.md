이번 설계는 지메일, 아웃룩과 같은 10억 사용자 규모의 대규모 분산 이메일 서비스 구축을 목표로 한다. 핵심 난제는 페타바이트(PB)급의 데이터를 처리하는 동시에, 데이터 안정성 및 정확성을 보장하며, 거의 실시간에 가까운 검색 기능을 제공하는 것이다.

시스템은 웹소켓을 활용한 실시간 통신과 마이크로서비스 아키텍처를 기반으로 함. 데이터 저장소는 분산 NoSQL 데이터베이스와 객체 저장소(첨부 파일) 로 구성되며, 특히 데이터 모델의 비정규화(Denormalization) 를 통해 읽은/읽지 않은 메일 필터링 등 NoSQL 환경에서의 질의 성능을 최적화함. 또한, 이메일 전송 성공률을 높이기 위한 전송 가능성(Deliverability) 확보 전략과, 쓰기 집약적인 검색 색인(LSM 트리) 전략이 주요 특징.

---

## 단계별 설계 분석

### 1. 문제 정의 및 규모 추정 (Massive Scale Challenge)

이메일 서비스는 데이터 안정성 및 확장성이 가장 중요하다.
- 규모: 사용자 10억 명, 일일 전송 QPS 10만.
- 저장소 요구량: 1년간 메타데이터 약 730 PB, 첨부 파일 약 1,460 PB로, 대규모 분산 저장소 솔루션이 필수적.
- 기능 요건: 이메일 송수신, 읽음/안 읽음 필터링, 실시간 검색, 스팸/바이러스 방지 등을 포함.

---

### 2. 개략적 아키텍처 및 워크플로

#### 2.1. 아키텍처 컴포넌트

전통적인 메일 서버의 한계(낮은 확장성, 불안정성)를 극복하기 위해 분산 아키텍처를 채택.

- 프론트엔드/API: 웹서버(HTTP) 및 실시간 서버(웹소켓/롱 폴링) 가 사용자 요청을 처리함.
- 데이터 계층: 메타데이터 DB (분산 NoSQL), 첨부 파일 저장소 (객체 저장소, 예: S3), 분산 캐시 (최근 이메일 캐싱), 검색 저장소 (역 인덱스 기반)로 구성.
- 비동기 처리: 분산 메시지 큐(Kafka) 를 도입하여 SMTP 서버와 메일 처리 프로세스 간의 결합도를 낮추고 독립적인 규모 확장을 보장.

#### 2.2. 이메일 전송/수신 워크플로

- 이메일 전송: 웹서버에서 기본 검증 후, 외부 전송 큐를 통해 비동기적으로 SMTP 작업 프로세스가 스팸/바이러스 검사 및 외부 서버로의 최종 발송을 수행.
- 이메일 수신: SMTP 서버가 수신 이메일을 수신 이메일 큐에 넣음. 메일 처리 작업 프로세스가 스팸/바이러스 필터링 후 저장소 계층에 저장함. 온라인 사용자에게는 실시간 서버를 통해 즉시 전달된다.

---

### 3. 상세 설계 및 핵심 기술

#### 3.1. 메타데이터 저장소 및 모델링

데이터베이스 선정: 대규모 이메일 시스템에 완벽한 단일 DB는 없으며, 맞춤형 분산 NoSQL DB가 가장 적합. 이는 강력한 데이터 일관성, 높은 가용성, 디스크 I/O 최소화 등의 특성을 충족해야 한다.

데이터 모델: `user_id`를 파티션 키로 사용하여 사용자별 데이터 격리 및 분산을 확보.

NoSQL 질의 최적화 (비정규화): NoSQL DB는 `is_read` 같은 속성에 대한 필터링 질의를 지원하기 어려움. 이를 해결하기 위해 `emails_by_folder` 테이블을 `read_emails` 와 `unread_emails` 두 개의 테이블로 분할하는 비정규화를 수행하여 질의 성능을 개선.

#### 3.2. 이메일 검색 구현 전략

이메일 검색은 쓰기(색인) 연산이 읽기(검색)보다 많고, 색인이 거의 실시간으로 이루어져야 함.

|전략|장점|단점|
|---|---|---|
|일래스틱서치|텍스트 검색에 강하며 통합이 쉬움.|주 저장소와 동기화 문제, 데이터 일관성 유지의 복잡성 발생함.|
|맞춤형 검색 솔루션|시스템 최적화가 용이하며 데이터 일관성 유지가 단순함.|높은 개발 비용과 엔지니어링 노력이 필요함.|

I/O 병목 해소: 맞춤형 솔루션 구현 시, 색인 구축의 쓰기 집약적 문제를 해결하기 위해 LSM (Log-Structured Merge) 트리 구조를 사용하여 순차적 쓰기 연산으로 디스크 I/O를 최소화함.

#### 3.3. 이메일 전송 가능성 (Deliverability) 확보

성공적인 이메일 전송을 위해 서버의 평판 관리가 필수적.

- 평판 구축: 전용 IP 사용, 마케팅/중요 메일의 범주화(다른 IP 사용), 새 IP의 점진적 사용(예열) 으로 대형 ISP에 대한 신뢰도를 높였다.
- 인증 및 보안: SPF, DKIM, DMARC 등의 이메일 인증 프로토콜을 구현하여 피싱을 방지하고 신뢰도를 증명.
- 피드백 처리: ISP로부터 반송(Bounce) 및 불만 신고(Complaint) 피드백을 수집하고 별도 큐를 통해 신속하게 처리하여 서버 평판 훼손을 방지.

#### 3.4. 규모 확장성 및 데이터 일관성

- 규모 확장: 사용자 데이터 접근 패턴이 독립적이므로, 대부분의 컴포넌트는 수평적으로 확장이 가능.
- 가용성: 여러 데이터센터에 데이터를 다중화하여 장애 발생 시 다른 데이터센터의 사본을 통해 서비스 가용성을 유지.
- 일관성: 이메일은 데이터 정확성이 중요하므로, 메일함은 하나의 주(Primary) 사본을 통해 서비스됨. 이는 데이터 일관성을 위해 일시적인 가용성을 희생하는 결정.

---

## 주요 용어 정리

- SMTP/POP/IMAP: 이메일 송수신에 사용되는 전통적인 프로토콜.
- MX 레코드 (Mail Exchange Record): DNS에 등록되어 수신자 도메인의 메일 서버 주소와 우선순위를 지정하는 레코드.
- MIME: 인터넷을 통해 첨부 파일을 포함한 다양한 형식의 이메일을 전송하는 표준 규격.
- 비정규화 (Denormalization): 질의 성능 향상을 위해 중복을 감수하고 데이터를 여러 테이블에 분산하여 저장하는 NoSQL 모델링 기법.
- LSM 트리 (Log-Structured Merge Tree): 쓰기 집약적인 작업에 최적화된 자료 구조로, 디스크에 순차적 쓰기만 수행하여 I/O를 최소화함. 카산드라, 빅테이블의 핵심 구조.
- SPF/DKIM/DMARC: 이메일 발신자 인증을 통해 스팸 및 피싱에 대응하는 표준 프로토콜임.
- 전송 가능성 (Deliverability): 보낸 이메일이 스팸 폴더로 가지 않고 수신자의 메일함에 성공적으로 도달하는 확률.